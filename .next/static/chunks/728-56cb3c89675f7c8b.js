"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[728],{857:function(e,t,o){o.d(t,{AuthProvider:function(){return r},a:function(){return c}});var n=o(7437),s=o(2265),a=o(6463);let i=(0,s.createContext)({token:null,active_school_id:null,isLoading:!0,login:async()=>{},logout:()=>{},setSchoolId:()=>{},isAuthenticated:!1});function r(e){let{children:t}=e,[o,r]=(0,s.useState)({token:null,active_school_id:null,isLoading:!0}),c=(0,a.useRouter)();(0,s.useEffect)(()=>{r({token:localStorage.getItem("token"),active_school_id:localStorage.getItem("active_school_id"),isLoading:!1})},[]);let l=async e=>{localStorage.setItem("token",e.token),r(t=>({...t,token:e.token,isLoading:!1}))},d={...o,login:l,logout:()=>{localStorage.removeItem("token"),localStorage.removeItem("active_school_id"),r({token:null,active_school_id:null,isLoading:!1}),c.replace("/login")},setSchoolId:e=>{localStorage.setItem("active_school_id",e),r(t=>({...t,active_school_id:e}))},isAuthenticated:!!o.token&&!o.isLoading};return(0,n.jsx)(i.Provider,{value:d,children:t})}let c=()=>(0,s.useContext)(i)},2191:function(e,t,o){o.d(t,{x:function(){return i}});var n=o(2265),s=o(6463),a=o(857);function i(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"/login",{token:t,isLoading:o}=(0,a.a)(),i=(0,s.useRouter)();return(0,n.useEffect)(()=>{if(!o&&!t){let t=window.location.pathname+window.location.search,o="".concat(e,"?next=").concat(encodeURIComponent(t));i.replace(o)}},[t,o,i,e]),{isAuthenticated:!!t&&!o,isLoading:o}}},459:function(e,t,o){o.d(t,{h:function(){return n}});let n=o(8472).Z.create({baseURL:"http://localhost:8000",timeout:2e4});n.interceptors.request.use(e=>{let t=localStorage.getItem("token"),o=localStorage.getItem("active_school_id");return t&&(e.headers.Authorization="Bearer ".concat(t)),o&&(e.headers["X-School-ID"]=o),e}),n.interceptors.response.use(e=>e,e=>{var t;return(null===(t=e.response)||void 0===t?void 0:t.status)===401&&(console.error("Unauthorized request detected"),localStorage.removeItem("token"),localStorage.removeItem("active_school_id"),window.location.href="/login"),Promise.reject(e)})},6195:function(e,t,o){o.d(t,{A:function(){return i}});var n=o(459),s=o(6575);let a=e=>e.map(e=>{var t,o,n,s;let a="USER"===e.message_type?"user":"assistant";(null===(t=e.response_data)||void 0===t?void 0:t.attachments)&&(console.log("=== TRANSFORMING MESSAGE WITH ATTACHMENTS ==="),console.log("Original message:",{id:e.id,message_type:e.message_type,content:e.content.substring(0,50)+"...",response_data:e.response_data}),console.log("Attachments found:",e.response_data.attachments.length),console.log("Will be role:",a));let i={role:a,content:e.content,blocks:"assistant"===a&&(null===(o=e.response_data)||void 0===o?void 0:o.blocks)?e.response_data.blocks:void 0,response_data:e.response_data,intent:e.intent,id:e.id,timestamp:e.created_at};return(null===(n=i.response_data)||void 0===n?void 0:n.attachments)&&console.log("Transformed display message:",{role:i.role,hasAttachments:!!(null===(s=i.response_data)||void 0===s?void 0:s.attachments),attachmentCount:i.response_data.attachments.length}),i}),i={async sendMessage(e,t,o){var a,i;let r=null!==(a=(0,s.rc)())&&void 0!==a?a:void 0;console.log("=== CHAT SERVICE SEND MESSAGE ==="),console.log("Message:",e),console.log("ConversationId:",t),console.log("Context:",o);try{let{data:a}=await n.h.post("/api/chat/message",{message:e,conversation_id:t,context:o});return console.log("Chat service response:",{conversation_id:a.conversation_id,intent:a.intent,response_preview:null===(i=a.response)||void 0===i?void 0:i.substring(0,100)}),a.conversation_id&&(t?s.MN.messageSent(a.conversation_id,{message:e,response:a.response},r):s.MN.conversationCreated(a.conversation_id,{title:e.slice(0,50)},r)),a}catch(e){throw console.error("Failed to send message:",e),e}},async sendMessageWithFiles(e,t,o){var a,i,r,c;let l=null!==(a=(0,s.rc)())&&void 0!==a?a:void 0;console.log("=== CHAT SERVICE SEND MESSAGE WITH FILES ==="),console.log("Message:",e),console.log("Files count:",t.length),console.log("ConversationId:",o),console.log("ConversationId type:",typeof o),console.log("ConversationId truthy:",!!o),o&&"new"!==o&&"undefined"!==o?console.log("âœ… Using existing conversation:",o):(console.log("\uD83D\uDCDD Will create new conversation"),o=void 0);let d=new FormData;for(let[n,s]of(d.append("message",e),o?(console.log("Appending conversation_id to form:",o),d.append("conversation_id",o)):console.log("Not appending conversation_id - will create new"),t.forEach((e,t)=>{console.log("Appending file ".concat(t,":"),e.name),d.append("files",e)}),console.log("FormData entries:"),d.entries()))"files"===n?console.log("  ".concat(n,": [File object]")):console.log("  ".concat(n,":"),s);try{console.log("\uD83D\uDE80 Making API call to /api/chat/message-with-files");let{data:t}=await n.h.post("/api/chat/message-with-files",d,{headers:{"Content-Type":"multipart/form-data"},timeout:12e4});return console.log("File message response:",{conversation_id:t.conversation_id,intent:t.intent,attachment_processed:t.attachment_processed,response_preview:null===(i=t.response)||void 0===i?void 0:i.substring(0,100)}),t.conversation_id&&(o?s.MN.messageSent(t.conversation_id,{message:e,response:t.response},l):s.MN.conversationCreated(t.conversation_id,{title:e.slice(0,50)},l)),t}catch(e){throw console.error("Failed to send message with files:",e),Error((null===(c=e.response)||void 0===c?void 0:null===(r=c.data)||void 0===r?void 0:r.detail)||e.message||"File processing failed")}},async getSuggestions(){let{data:e}=await n.h.get("/api/chat/suggestions");return e},async getConversations(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20,o=arguments.length>2&&void 0!==arguments[2]&&arguments[2];try{let{data:s}=await n.h.get("/api/chat/conversations",{params:{page:e,limit:t,include_archived:o}});return s}catch(e){throw console.error("Failed to get conversations:",e),e}},async getConversation(e){try{var t;console.log("=== GETTING CONVERSATION ===",e);let{data:o}=await n.h.get("/api/chat/conversations/".concat(e));console.log("Raw conversation data:",{id:o.id,title:o.title,messageCount:(null===(t=o.messages)||void 0===t?void 0:t.length)||0}),o.messages&&o.messages.forEach((e,t)=>{var o;(null===(o=e.response_data)||void 0===o?void 0:o.attachments)&&console.log("Message ".concat(t," has attachments:"),{message_type:e.message_type,content:e.content.substring(0,50),attachments:e.response_data.attachments.length})});let s=a(o.messages||[]);return console.log("Transformed display messages:",s.length),s.forEach((e,t)=>{var o;(null===(o=e.response_data)||void 0===o?void 0:o.attachments)&&console.log("Display message ".concat(t,":"),{role:e.role,hasAttachments:!0,attachmentCount:e.response_data.attachments.length})}),{...o,displayMessages:s}}catch(e){throw console.error("Failed to get conversation:",e),e}},async updateConversation(e,t){var o;let a=null!==(o=(0,s.rc)())&&void 0!==o?o:void 0;try{let{data:o}=await n.h.patch("/api/chat/conversations/".concat(e),t);return s.MN.conversationUpdated(e,t,a),o}catch(e){throw console.error("Failed to update conversation:",e),e}},async deleteConversation(e){var t;let o=null!==(t=(0,s.rc)())&&void 0!==t?t:void 0;try{await n.h.delete("/api/chat/conversations/".concat(e)),s.MN.conversationDeleted(e,o)}catch(e){throw console.error("Failed to delete conversation:",e),e}},async getRecentConversations(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:7,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;try{let{data:o}=await n.h.get("/api/chat/conversations/recent",{params:{days:e,limit:t}});return o}catch(e){throw console.error("Failed to get recent conversations:",e),e}},async searchConversations(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20;try{let{data:o}=await n.h.get("/api/chat/conversations/search",{params:{q:e,limit:t}});return o}catch(e){throw console.error("Failed to search conversations:",e),e}},forceRefresh(){var e;let t=null!==(e=(0,s.rc)())&&void 0!==e?e:void 0;s.MN.forceRefresh(t)},async list(){return(await this.getConversations(1,50)).conversations.map(e=>({id:e.id,title:e.title,is_starred:!1,created_at:e.created_at,updated_at:e.last_activity}))},async get(e){let t=await this.getConversation(e);return{chat:{id:t.id,title:t.title,is_starred:!1},messages:t.displayMessages}},create:async()=>({id:"new",title:"New Chat",messages:[]}),async update(e,t){return t.title&&await this.updateConversation(e,{title:t.title}),{id:e,...t}},async delete(e){await this.deleteConversation(e)},star:async e=>(console.warn("Starring not implemented on backend yet"),{id:e,is_starred:!0}),unstar:async e=>(console.warn("Unstarring not implemented on backend yet"),{id:e,is_starred:!1}),async rename(e,t){return await this.updateConversation(e,{title:t})}}},6575:function(e,t,o){o.d(t,{MN:function(){return s},rc:function(){return a}}),o(2265);class n{notifyListeners(e){let t=this.listeners.get(e.type)||[],o=this.listeners.get("*")||[];t.concat(o).forEach(t=>{try{t(e)}catch(e){console.error("Error in chat event listener:",e)}})}subscribe(e,t){return this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t),()=>{let o=this.listeners.get(e)||[],n=o.indexOf(t);n>-1&&o.splice(n,1)}}broadcast(e,t,o,n){let s={type:e,conversationId:t,data:o,timestamp:Date.now(),userId:n};try{localStorage.setItem("chat_event",JSON.stringify(s)),this.lastEventTimestamp=s.timestamp,setTimeout(()=>{try{let e=localStorage.getItem("chat_event");e&&JSON.parse(e).timestamp===s.timestamp&&localStorage.removeItem("chat_event")}catch(e){}},100)}catch(e){console.error("Error broadcasting chat event:",e)}}conversationCreated(e,t,o){this.broadcast("conversation_created",e,t,o)}conversationUpdated(e,t,o){this.broadcast("conversation_updated",e,t,o)}conversationDeleted(e,t){this.broadcast("conversation_deleted",e,void 0,t)}messageSent(e,t,o){this.broadcast("message_sent",e,t,o)}forceRefresh(e){this.broadcast("force_refresh",void 0,void 0,e)}destroy(){window.removeEventListener("storage",this.handleStorageEvent),window.removeEventListener("focus",this.handleWindowFocus),document.removeEventListener("visibilitychange",this.handleVisibilityChange),this.listeners.clear()}constructor(){this.listeners=new Map,this.lastEventTimestamp=0,this.handleStorageEvent=e=>{if("chat_event"===e.key&&e.newValue)try{let t=JSON.parse(e.newValue);if(t.timestamp<=this.lastEventTimestamp)return;this.lastEventTimestamp=t.timestamp,this.notifyListeners(t)}catch(e){console.error("Error parsing chat event:",e)}},this.handleWindowFocus=()=>{this.broadcast("force_refresh")},this.handleVisibilityChange=()=>{document.hidden||this.broadcast("force_refresh")},window.addEventListener("storage",this.handleStorageEvent.bind(this)),window.addEventListener("focus",this.handleWindowFocus.bind(this)),document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this))}}let s=new n;function a(){try{let e=localStorage.getItem("token");if(!e)return null;return JSON.parse(atob(e.split(".")[1])).sub||null}catch(e){return null}}}}]);