(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[453],{8966:function(e,t,n){Promise.resolve().then(n.bind(n,3129))},3129:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return i}});var o=n(7437),a=n(6463),s=n(6195),r=n(2191);function i(){let{isAuthenticated:e}=(0,r.x)(),t=(0,a.useRouter)(),n=async()=>{try{let e=await s.A.create();t.push("/chat/".concat(e.id))}catch(o){var e,n;if(console.error("Failed to create chat:",o),(null==o?void 0:null===(e=o.response)||void 0===e?void 0:e.status)===401||(null==o?void 0:null===(n=o.response)||void 0===n?void 0:n.status)===403){let e=window.location.pathname+window.location.search;t.replace("/login?next=".concat(encodeURIComponent(e)))}}};return e?(0,o.jsxs)("div",{className:"card",children:[(0,o.jsx)("h2",{children:"Start a new chat"}),(0,o.jsx)("button",{onClick:n,children:"Create"})]}):null}},857:function(e,t,n){"use strict";n.d(t,{AuthProvider:function(){return i},a:function(){return c}});var o=n(7437),a=n(2265),s=n(6463);let r=(0,a.createContext)({token:null,active_school_id:null,isLoading:!0,login:async()=>{},logout:()=>{},setSchoolId:()=>{},isAuthenticated:!1});function i(e){let{children:t}=e,[n,i]=(0,a.useState)({token:null,active_school_id:null,isLoading:!0}),c=(0,s.useRouter)();(0,a.useEffect)(()=>{i({token:localStorage.getItem("token"),active_school_id:localStorage.getItem("active_school_id"),isLoading:!1})},[]);let l=async e=>{localStorage.setItem("token",e.token),i(t=>({...t,token:e.token,isLoading:!1}))},d={...n,login:l,logout:()=>{localStorage.removeItem("token"),localStorage.removeItem("active_school_id"),i({token:null,active_school_id:null,isLoading:!1}),c.replace("/login")},setSchoolId:e=>{localStorage.setItem("active_school_id",e),i(t=>({...t,active_school_id:e}))},isAuthenticated:!!n.token&&!n.isLoading};return(0,o.jsx)(r.Provider,{value:d,children:t})}let c=()=>(0,a.useContext)(r)},2191:function(e,t,n){"use strict";n.d(t,{x:function(){return r}});var o=n(2265),a=n(6463),s=n(857);function r(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"/login",{token:t,isLoading:n}=(0,s.a)(),r=(0,a.useRouter)();return(0,o.useEffect)(()=>{if(!n&&!t){let t=window.location.pathname+window.location.search,n="".concat(e,"?next=").concat(encodeURIComponent(t));r.replace(n)}},[t,n,r,e]),{isAuthenticated:!!t&&!n,isLoading:n}}},459:function(e,t,n){"use strict";n.d(t,{h:function(){return s}});var o=n(8472),a=n(357);let s=o.Z.create({baseURL:a.env.NEXT_PUBLIC_API_BASE_URL||"http://localhost:8000",timeout:2e4});s.interceptors.request.use(e=>{let t=localStorage.getItem("token"),n=localStorage.getItem("active_school_id");return t&&(e.headers.Authorization="Bearer ".concat(t)),n&&(e.headers["X-School-ID"]=n),e}),s.interceptors.response.use(e=>e,e=>{var t;return(null===(t=e.response)||void 0===t?void 0:t.status)===401&&(console.error("Unauthorized request detected"),localStorage.removeItem("token"),localStorage.removeItem("active_school_id"),window.location.href="/login"),Promise.reject(e)})},6195:function(e,t,n){"use strict";n.d(t,{A:function(){return r}});var o=n(459),a=n(6575);let s=e=>e.map(e=>{var t;let n="USER"===e.message_type?"user":"assistant";return{role:n,content:e.content,blocks:"assistant"===n&&(null===(t=e.response_data)||void 0===t?void 0:t.blocks)?e.response_data.blocks:void 0}}),r={async sendMessage(e,t,n){var s;let r=null!==(s=(0,a.rc)())&&void 0!==s?s:void 0;try{let{data:s}=await o.h.post("/api/chat/message",{message:e,conversation_id:t,context:n});return s.conversation_id&&(t?a.MN.messageSent(s.conversation_id,{message:e,response:s.response},r):a.MN.conversationCreated(s.conversation_id,{title:e.slice(0,50)},r)),s}catch(e){throw console.error("Failed to send message:",e),e}},async getSuggestions(){let{data:e}=await o.h.get("/api/chat/suggestions");return e},async getConversations(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];try{let{data:a}=await o.h.get("/api/chat/conversations",{params:{page:e,limit:t,include_archived:n}});return a}catch(e){throw console.error("Failed to get conversations:",e),e}},async getConversation(e){try{let{data:t}=await o.h.get("/api/chat/conversations/".concat(e)),n=s(t.messages||[]);return{...t,displayMessages:n}}catch(e){throw console.error("Failed to get conversation:",e),e}},async updateConversation(e,t){var n;let s=null!==(n=(0,a.rc)())&&void 0!==n?n:void 0;try{let{data:n}=await o.h.patch("/api/chat/conversations/".concat(e),t);return a.MN.conversationUpdated(e,t,s),n}catch(e){throw console.error("Failed to update conversation:",e),e}},async deleteConversation(e){var t;let n=null!==(t=(0,a.rc)())&&void 0!==t?t:void 0;try{await o.h.delete("/api/chat/conversations/".concat(e)),a.MN.conversationDeleted(e,n)}catch(e){throw console.error("Failed to delete conversation:",e),e}},async getRecentConversations(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:7,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;try{let{data:n}=await o.h.get("/api/chat/conversations/recent",{params:{days:e,limit:t}});return n}catch(e){throw console.error("Failed to get recent conversations:",e),e}},async searchConversations(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20;try{let{data:n}=await o.h.get("/api/chat/conversations/search",{params:{q:e,limit:t}});return n}catch(e){throw console.error("Failed to search conversations:",e),e}},forceRefresh(){var e;let t=null!==(e=(0,a.rc)())&&void 0!==e?e:void 0;a.MN.forceRefresh(t)},async list(){return(await this.getConversations(1,50)).conversations.map(e=>({id:e.id,title:e.title,is_starred:!1,created_at:e.created_at,updated_at:e.last_activity}))},async get(e){let t=await this.getConversation(e);return{chat:{id:t.id,title:t.title,is_starred:!1},messages:t.displayMessages}},create:async()=>({id:"new",title:"New Chat",messages:[]}),async update(e,t){return t.title&&await this.updateConversation(e,{title:t.title}),{id:e,...t}},async delete(e){await this.deleteConversation(e)},star:async e=>(console.warn("Starring not implemented on backend yet"),{id:e,is_starred:!0}),unstar:async e=>(console.warn("Unstarring not implemented on backend yet"),{id:e,is_starred:!1}),async rename(e,t){return await this.updateConversation(e,{title:t})}}},6575:function(e,t,n){"use strict";n.d(t,{MN:function(){return a},rc:function(){return s}}),n(2265);class o{notifyListeners(e){let t=this.listeners.get(e.type)||[],n=this.listeners.get("*")||[];t.concat(n).forEach(t=>{try{t(e)}catch(e){console.error("Error in chat event listener:",e)}})}subscribe(e,t){return this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t),()=>{let n=this.listeners.get(e)||[],o=n.indexOf(t);o>-1&&n.splice(o,1)}}broadcast(e,t,n,o){let a={type:e,conversationId:t,data:n,timestamp:Date.now(),userId:o};try{localStorage.setItem("chat_event",JSON.stringify(a)),this.lastEventTimestamp=a.timestamp,setTimeout(()=>{try{let e=localStorage.getItem("chat_event");e&&JSON.parse(e).timestamp===a.timestamp&&localStorage.removeItem("chat_event")}catch(e){}},100)}catch(e){console.error("Error broadcasting chat event:",e)}}conversationCreated(e,t,n){this.broadcast("conversation_created",e,t,n)}conversationUpdated(e,t,n){this.broadcast("conversation_updated",e,t,n)}conversationDeleted(e,t){this.broadcast("conversation_deleted",e,void 0,t)}messageSent(e,t,n){this.broadcast("message_sent",e,t,n)}forceRefresh(e){this.broadcast("force_refresh",void 0,void 0,e)}destroy(){window.removeEventListener("storage",this.handleStorageEvent),window.removeEventListener("focus",this.handleWindowFocus),document.removeEventListener("visibilitychange",this.handleVisibilityChange),this.listeners.clear()}constructor(){this.listeners=new Map,this.lastEventTimestamp=0,this.handleStorageEvent=e=>{if("chat_event"===e.key&&e.newValue)try{let t=JSON.parse(e.newValue);if(t.timestamp<=this.lastEventTimestamp)return;this.lastEventTimestamp=t.timestamp,this.notifyListeners(t)}catch(e){console.error("Error parsing chat event:",e)}},this.handleWindowFocus=()=>{this.broadcast("force_refresh")},this.handleVisibilityChange=()=>{document.hidden||this.broadcast("force_refresh")},window.addEventListener("storage",this.handleStorageEvent.bind(this)),window.addEventListener("focus",this.handleWindowFocus.bind(this)),document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this))}}let a=new o;function s(){try{let e=localStorage.getItem("token");if(!e)return null;return JSON.parse(atob(e.split(".")[1])).sub||null}catch(e){return null}}}},function(e){e.O(0,[236,971,23,744],function(){return e(e.s=8966)}),_N_E=e.O()}]);